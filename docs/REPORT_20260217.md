# Report 2026-02-17

## 件名
`size_mode=local` で配置した家具を Isaac Sim 上で手動移動した際に、意図せず回転が変化する問題の修正。

## 背景
- 置換（replace）や手動移動後に、家具が勝手に回転する不具合が発生。
- ログには以下が継続して出力されていた。
  - `Incompatible xformOpOrder, rotation or translation applied before scale.`
  - `xformOp 'xformOp:rotateZ' already exists in xformOpOrder ...`

## 原因
- Local mode の単一Prim内に「配置用回転」「オフセット回転」「upAxis補正」「スケール」が同居していた。
- その状態でビューポートのギズモがトランスフォームを再解釈する際、既存 `xformOpOrder` と競合し、回転opが重複/再構成されて姿勢が崩れていた。

## 実装した修正
変更ファイル:
- `my/research/asset_placer_isaac/core/commands.py`
- `my/research/asset_placer_isaac/core/state.py`

主な内容:
1. Local mode の構造を2層化
- 親Prim（配置Prim）: 手動操作対象
  - `xformOp:translate`
  - `xformOp:rotateZ`
- 子Prim（`__local_ref`）: 形状正規化とスケール担当
  - 参照（reference）
  - `xformOp:rotateZ:offset`
  - `xformOp:rotateX:up`（Y-up資産のみ）
  - `xformOp:scale:local`

2. 参照の集約
- Local mode では参照を子Primへ集約し、親Primの参照はクリア。
- Replace時も同じ経路で再適用されるようにした。

3. 参照Prim解決の改善
- `_get_reference_prim()` で「最初に見つかった reference prim」よりも、`asset_placer.*` メタデータを持つPrim（通常は親配置Prim）を優先。
- 置換/再適用時に誤って子Prim側だけを対象にしてしまうケースを回避。

4. 操作互換性の最終調整
- 親Primの `translate/rotateZ` は unsuffixed op に統一し、ギズモ互換性を優先。

## 期待される効果
- 手動で移動しても姿勢が勝手に変わらない。
- Replace後も `rotationZ`（world向き）が保持される。
- `xformOp` 重複警告の発生を抑制。

## 注意点
- 既に配置済みの旧オブジェクトは、旧 `xformOpOrder` を保持している場合がある。
- 旧オブジェクトは「再生成」または「replaceを1回実行」で新構造へ更新してから確認すること。

## 関連コミット
- `9f3ca58` Fix local-mode transform stack drift on manual move
- `45b6a52` Use unsuffixed parent ops for local-mode manipulator compatibility
